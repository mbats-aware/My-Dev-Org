name: QA Deployment

on: workflow_dispatch

jobs:
  validate:
    # if: github.event.pull_request.merge == true
    runs-on: ubuntu-latest
    environment: QA
    container:
      image: awareservices/sfdx-cli:latest
    steps:
      - name: Authenticating QA Org
        run: |
          echo ${{ secrets.AUTH_URL }} > authURL
          sfdx auth:sfdxurl:store -f ./authURL -a "QA Org"
      - name: Generate Delta Changes
        run: |
          export HOME=/root
          sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output "deploy/" --source force-app/main/default --ignore .forceignore
          echo "--- package.xml generated with added and modified metadata ---"
          cat deploy/package/package.xml
          echo
          echo "--- destructiveChanges.xml generated with deleted metadata ---"
          cat deploy/destructiveChanges/destructiveChanges.xml
      - name: Validating Deployment
        run: |
          sfdx force:source:deploy -p "deploy/" -c --verbose

