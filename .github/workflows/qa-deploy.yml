name: QA Deployment

on: 
  workflow_dispatch:
    paths:
      - "force-app/main/default/**"

jobs:
  validate:
    # if: github.event.pull_request.merge == true
    runs-on: ubuntu-latest
    environment: QA
    container:
      image: awareservices/sfdx-cli:latest
    steps:
      - name: Authenticating QA Org
        run: |
          echo ${{ secrets.AUTH_URL }} > authURL
          sfdx auth:sfdxurl:store -f authURL -a "QA Org"
      - name: Install SFDX GIT delta
        run: |
          echo y | sfdx plugins:install sfdx-git-delta
          sfdx sgd:source:delta --to "HEAD" --from "HEAD^"  --output "deploy/" --source force-app/main/default --ignore .forceignore
          cat package.xml
      - uses: sfdx-actions/setup-sfdx@v1
        with:
          sfdx-auth-url: ${{ secrets.AUTH_URL }}
      - name: Validate Deployment
        run: |
            if grep -q '<types>' deploy/package/package.xml; then
              echo "--- Validating deploying added and modified metadata ---"
              sfdx force:source:deploy -x deploy/package.xml -u "QA Org" -l RunLocalTests -c
              echo
            fi

