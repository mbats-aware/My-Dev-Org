name: 'QA Validation'

on: 
  workflow_dispatch:
    inputs:
      feature_branch:
        name: Feature Branch
        required: true
        type: string

jobs:
  QA_validation:
    runs-on: ubuntu-latest
    environment: QA
    container:
      image: awareservices/sfdx-cli:latest
    steps:
      - name: Checkout Sources
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Authenticate QA Org
        run: |
            echo ${{ secrets.QA_AUTH_URL }} > authURL
            sfdx auth:sfdxurl:store -f authURL -a QA
      - name: Run Validation
        run: |
          export HOME=/root
          sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output "qa/deploy/" --source force-app/main/default --ignore .forceignore
          echo "--- package.xml generated with added and modified metadata ---"
          cat qa/deploy/package/package.xml
          echo
          echo "--- destructiveChanges.xml generated with deleted metadata ---"
          cat qa/deploy/destructiveChanges/destructiveChanges.xml
      - name: Validate Deployment
        run: |
            if grep -q '<types>' qa/deploy/package/package.xml; then
              echo "--- Validating deploying added and modified metadata ---"
              sfdx force:source:deploy -x qa/deploy/package/package.xml -u QA -l RunLocalTests -c
              echo
            fi
            if grep -q '<types>' qa/deploy/destructiveChanges/destructiveChanges.xml; then
              echo "--- Validating deleting removed metadata ---"
              sfdx force:mdapi:deploy -d qa/deploy/destructiveChanges --ignorewarnings -u QA -l RunLocalTests -c --wait -1
              echo
            fi